# ProcessingScripts documentation

This directory contains two different sets of files. One set is a collection of
scripts to process the data, the second set contain a data set that serves as
an example.

The processing scripts are:

- `example.sh`
  - The script that runs the example from beginning to end
- `prepare_target.sh`
  - The script that prepares the target in the right format for the docking
    software
- `smiles_dock.sh`
  - The script that docks all the ligands given as a collection of SMILES
    strings
- `summarize.sh`
  - The script that goes through the collection of SMILES strings and
    summarizes the results over all SMILES strings

The example data files are:

- `3CLPro_protein.pdb`
  - The structure of the target protein
- `ena+db-small.can`
  - A small set of ligand SMILES strings
- `summary.txt`
  - The summary of the results from the example

## The `prepare_target.sh` script

Initially the protein is given in a Protein DataBank (PDB) format file.  This
file contains the structure of the protein. In practice it means that all the
non-hydrogen atoms are given along with their positions and other data that is
relevant to biology (the amino acid residue it is a part of, the protein chain
it sits in, etc.)

For the docking it is important to get the potential generated by the presence
of the protein right. This includes the electrostatic potential terms for which
the charges on the protein atoms are needed. These charges are included in
PDBQT files.

This script converts the PDB file into a PDBQT file while estimating the
charges on the atoms and also adding hydrogen atoms which are typically missing
from PDB files (this is a consequence of the limitations of the X-ray
diffraction technique that is often used to experimentally obtain the protein
structure). The actual command is

```
pythonsh $AUTODOCKTOOLS_UTIL/prepare_receptor4.py -r <protein>.pdb \
        -o <protein>.pdbqt -A hydrogen
```

Note that it is important to run `prepare_receptor4.py` as this produces a
different PDBQT file format from `prepare_receptor.py`.

This script needs to be run once for every protein that a docking study is
targetting.

## The `smiles_dock.sh` script

The `smiles_dock.sh` takes a file containing lines that each contains a SMILES
string of a molecule and an identifier. It loops over all SMILES strings and
docks each molecule to a given protein.

Initially the ligand is given as a SMILES string. To dock it to a protein
target first of all a 3D structure of the molecule is needed. This structure
also needs to have charges on the atoms to construct a reasonable electrostatic
potential around the ligand. Furthermore, the Autodock expression for the
interaction between protein and ligand depends on the types of atoms present.
To perform the docking efficiently the potential from the protein is expressed
on a grid. To account for the different atoms multiple potential grids are
calculated for different atom types.

Given all that is needed, the docking of the SMILES string proceeds through a
number of steps.

### 1. Convert the SMILES string to a 3D structure stored in MOL2 format

Openbabel converts the SMILES string to a 3D structure, estimates the
fractional charges on the atoms, and stores the structure in a MOL2 format.

```
echo "$smiles" | obabel -h --gen3d -ismi -omol2 > $id.mol2
```

where `$smiles` contains the SMILES string, `$id` contains an identifier.

### 2. Convert the MOL2 format file to a PDBQT file that Autodock understands

Run

```
pythonsh $AUTODOCKTOOLS_UTIL/prepare_ligand4.py -l $id.mol2  -o $id.pdbqt
```

Again, use `prepare_ligand4.py` because `prepare_ligand.py` produces the wrong
format for Autodock4.

### 3. Prepare the grid parameters file

For the calculation of the protein potential grids the Autodock tools need to
know: what atom types are present in the ligand, and also what box in space
needs to be gridded. The box is defined by the center point of the box, and the
number of grid points in each direction. The grid spacing (default 0.375
Angstrom) with the number of points defines the box size. In addition the code
requires that the numbers of grid points all be even.

```
pythonsh $AUTODOCKTOOLS_UTIL/prepare_gpf4.py -l $id.pdbqt -r $1.pdbqt \
        -p npts="$4" -p gridcenter="$3" -o $id.gpf
```

where `$id.pdbqt` is the file containing the ligand, `$1.pdbqt` is file
containing the target protein, `$4` contains the number of grid points (e.g.
"10,12,14"), `$3` contains the grid center "-10.0,20.0,13.5", and `$id.gpf` is
the grid parameter file.

### 4. Compute the grids

Run the `autogrid4` command to generate the potential grids.

```
autogrid4 -p $id.gpf -l $id.glg
```

where `$id.gpf` is the name of the grid parameter file, and `$id.glg` is the
grid log file.

### 5. Prepare the docking parameters file

We use mostly the default settings for the actual docking.

```
pythonsh $AUTODOCKTOOLS_UTIL/prepare_dpf42.py -p ga_run=20 -l $id.pdbqt -r $1.pdbqt -o $id.dpf
```

where `$id.pdbqt` contains the ligand molecule, `$1.pdbqt` contains the target
protein, and `$id.dpf` is the resulting docking parameter file.

### 6. Do the actual docking

With all inputs predefined we just run:

```
autodock4 -p $id.dpf -l $id.dlg
```

where `$id.dpf` is the docking parameter file, `$id.dlg` is the docking log
file.  The log file contains all important data, including the information to
reconstruct the docked structures (position, orientation and conformation), as
well as all important descriptor, such as the docking score, different energy
terms, etc.  After the docking is done, the log file is the only file you need
to keep for a given ligand.

## The `summary.sh` script

After all the ligands have been docked to a target you will want to have a
summary of the results. The `summary.sh` goes over all the docking log files
and extracts the relevant information. For every ligand a line is added to the
summary file.

After reviewing the results you might want to extract the bound structures of
the best docked structures, and visually inspect whether these structures make
sense. This can be done with additional tools.

# Submit parallel job using GNU parallel

1) Put protein PDB file to `./data`, copy `./scripts` to your working
directory.

2) Put protein list and corresponding pocket, grid, grid parameter in a file.

3) Edit `./scripts/run_sub_par.sh` to change the timeout limit.

4) Edit `sub_gnu_parallel_per_node.sl` to the file name for smiles and protein
list, run time, number of nodes. The `sub_gnu_parallel_per_process.sl` will
call srun once for every molecule.

5) run `sbatch sub_gnu_parallel_per_node.sl` to submit the job to the batch
system.
